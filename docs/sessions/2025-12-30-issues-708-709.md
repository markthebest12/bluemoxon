# Session: Issues #708 and #709 - Cost Data & Evaluation Bugs

**Date:** 2025-12-30 (continued 2025-12-31)
**Current Branch:** `main` (fix deployed to production)

---

## CRITICAL REMINDERS FOR NEXT SESSION

### 1. ALWAYS Use Superpowers Skills (MANDATORY)
```
INVOKE BEFORE ANY ACTION:
- superpowers:systematic-debugging - BEFORE any fix attempts
- superpowers:test-driven-development - BEFORE writing implementation code
- superpowers:verification-before-completion - BEFORE claiming work is done
- superpowers:brainstorming - BEFORE any creative/feature work
- superpowers:using-superpowers - When unsure which skill applies

IF A SKILL APPLIES, YOU MUST USE IT. NO EXCEPTIONS.
```

### 2. NEVER Use These (Permission Prompts)
```
FORBIDDEN - These trigger permission prompts:
- # comment lines before commands
- \ backslash line continuations
- $(...) command substitution
- || or && chaining
- ! in quoted strings (like 'Test1234!')
```

### 3. ALWAYS Use
```
REQUIRED:
- Simple single-line commands
- Separate sequential Bash tool calls instead of &&
- bmx-api for all BlueMoxon API calls (no permission prompts)
- CI/CD workflow: branch → lint → commit → PR → CI → merge
- WAIT FOR USER REVIEW before merging PRs
```

---

## Issue #708: Cost Data Tab Not Showing New Information

### Status: CLOSED (2025-12-31)

**PR:** #710 (merged)
**Issue:** Closed with verification - cost data now shows current dates (Dec 30, Dec 31)

### Root Cause
1. **Frontend timezone bug** - `new Date("2025-12-27")` parses as midnight UTC, displays as Dec 26 in US timezones
2. **Missing context** - Daily trend only shows days with Bedrock usage

### Fixes Applied
- UTC date parsing, force refresh button, explanatory text

---

## Issue #709: Evaluation Runbook Not Providing Market Comparables

### Status: PARTIALLY FIXED - Scraper works, but Claude filtering too aggressive

**PR:** #711 (merged to staging), #712 (promoted to production)

### What Was Fixed (Issue A)
**Scraper Lambda now handles search URLs correctly.**

Before: `extract_item_id()` was called on search URLs like `/sch/i.html?...`, causing:
```
ValueError: Could not extract eBay item ID from URL
```

After: Check for `extract_listings` mode before item ID extraction.

**Files Modified:**
- `scraper/handler.py` - Skip item ID extraction when `extract_listings=True`
- `scraper/test_handler.py` - Added regression test

### What Still Needs Fixing (Issue B)
**Claude's relevance filtering rejects ALL eBay listings.**

Evidence from book 537 (Origin of Species):
```json
{
  "fmv_low": "350.00",
  "fmv_high": "750.00",
  "fmv_notes": "No comparable listings found",
  "ebay_comparables": [],
  "abebooks_comparables": []
}
```

The scraper extracted 60 eBay listings, but Claude filtered them all out as "low" relevance.
The FMV range ($350-$750) comes from a fallback algorithm, NOT actual comparables.

---

## Root Cause Analysis: BlueMoxon vs Book-Collection

### Book-Collection Approach (Working)
From `~/projects/book-collection/PROMPTS_REFERENCE.md` and `ACQUISITION_EVALUATION_PROTOCOL.md`:

**Basic Analysis:**
- Search AbeBooks for 2-3 comparable copies
- Calculate discount: `(Market Price - Asking) / Market Price × 100`
- Threshold: ≥20% discount (prefer ≥40%)

**Full Evaluation (3-5 comparables required):**
- AbeBooks (ABAA/ILAB dealers prioritized)
- ViaLibri (MANDATORY)
- Biblio
- Auction Houses (Bonhams, Heritage, Swann - past 12-24 months)
- eBay Completed Listings (last 90 days, "Sold" only)

**Key Filtering Rules:**
- Half leather vs Full morocco distinction (50-60% value difference)
- Condition normalization (±10-20%)
- NO era-based rejection - uses condition and binding match instead

### BlueMoxon Approach (Broken)
From `backend/app/services/fmv_lookup.py` lines 259-352:

**Problems identified:**
1. **Era guidance too strict:** "within ~50 years", "Modern reprints post-1950 are LOW"
2. **Only high/medium pass:** Line 314: "Only include listings rated 'high' or 'medium' in your response"
3. **No fallback:** When all listings rated "low", returns empty array
4. **Missing sources:** Only uses eBay and AbeBooks, not ViaLibri/Biblio/Auctions

### Reconciliation Needed
The BlueMoxon FMV lookup needs to align with book-collection methodology:

1. **Remove/relax era restriction** - Focus on binding type and condition match instead
2. **Add fallback for "low" relevance** - If no high/medium, include best "low" matches
3. **Add ViaLibri as mandatory source** - Per book-collection protocol
4. **Use binding-type matching** - Half leather vs full morocco distinction
5. **Normalize for condition** - ±10-20% adjustments

---

## Next Steps for Issue #709 (Phase 2)

### Option A: Relax Claude Filtering (Quick Fix)
Modify `_filter_listings_with_claude()` in `fmv_lookup.py`:
- Remove "within ~50 years" era guidance
- Add fallback: if all "low" relevance, return top 5 by price match
- Focus on: binding type, condition, completeness

### Option B: Align with Book-Collection Protocol (Full Fix)
1. Add ViaLibri search (mandatory per protocol)
2. Implement binding-type normalization (half leather vs full morocco)
3. Implement condition-based price adjustment (±10-20%)
4. Use book-collection's filtering criteria instead of era-based

### Files to Modify
- `backend/app/services/fmv_lookup.py` - Claude filtering prompts
- Possibly add ViaLibri integration

### Commands to Start Next Session
```bash
# Verify current state
git branch
bmx-api GET "/books/537/eval-runbook" | jq '{ebay_count: (.ebay_comparables | length), fmv_notes}'

# Read the filtering code
# File: backend/app/services/fmv_lookup.py lines 259-352

# Create new branch for filtering fix
git checkout -b fix/fmv-filtering-709-phase2 origin/staging
```

---

## Key Learnings

1. **Verify the USER-FACING outcome, not just technical fix** - Scraper working doesn't mean comparables appear
2. **Wait for user review before merging PRs** - Don't rush to merge
3. **Compare with working implementation** - book-collection has proven methodology
4. **verification-before-completion skill is mandatory** - Evidence before claims

---

## Files Reference

| File | Purpose |
|------|---------|
| `scraper/handler.py` | eBay scraper Lambda - FIXED |
| `scraper/test_handler.py` | Scraper tests - TEST ADDED |
| `backend/app/services/fmv_lookup.py` | FMV lookup service - NEEDS FILTERING FIX |
| `~/projects/book-collection/PROMPTS_REFERENCE.md` | Reference for filtering methodology |
| `~/projects/book-collection/ACQUISITION_EVALUATION_PROTOCOL.md` | Reference for comparable sources |
