# Session: 2026-02-01 04:00

## Issue/Task
Entity Profiles Phase 4 — Production deployment, terraform apply, and profile worker bug fixes.
Issues: #1605, #1606, #1607

## Current Branch
`fix/profile-worker-bedrock-iam` (PR #1608 to staging, CI running)

## Progress
- [x] Wave 4: Promoted staging → main via PR #1604 (--merge), deploy succeeded, E2E smoke passed
- [x] Lane E: First terraform apply to production — 14 profile-worker resources created
- [x] Triggered batch generation (264 entities) — all failed due to bugs
- [x] Discovered 3 bugs in profile-worker Lambda:
  - #1605: Missing dependency layer (deploy skipped because terraform state didn't have function yet)
  - #1606: Bedrock IAM policy missing Haiku model ID
  - #1607: Unrestricted concurrency (already fixed on staging commit `7056015f`)
- [x] Manually fixed layer attachment and concurrency on production (hotfix)
- [x] Validated EBB profile via synchronous `/regenerate` endpoint — works perfectly
- [x] Tested SQS queue with single message — Lambda ran but hit Bedrock AccessDeniedException
- [x] Created GH issues #1605, #1606, #1607
- [x] Created fix branch `fix/profile-worker-bedrock-iam` with:
  - Extracted `bedrock_model_ids` to `locals.tf` (eliminates 4x duplication)
  - Fixed all 4 Lambda modules to use `local.bedrock_model_ids`
  - Fixed eval-runbook-worker which also had stale wildcards
  - Updated stale README examples
- [x] Code review completed, all High/Medium findings addressed
- [x] PR #1608 created to staging, CI running
- [ ] Merge PR #1608 to staging
- [ ] Apply terraform to staging (creates profile-worker on staging)
- [ ] Apply terraform to production (updates IAM policies)
- [ ] Test SQS queue end-to-end with single message on production
- [ ] Run batch generation for all 264 entities

## Key Decisions
- Extracted bedrock_model_ids to locals.tf to prevent drift between modules (root cause of #1606)
- Skipped review finding #5 (tighten inference-profile wildcard) — pragmatic for internal Lambdas
- #1605 is operational, not a code bug — deploy reads from terraform state, so terraform apply must precede first deploy for new Lambdas
- Applied hotfixes directly to production for layer and concurrency (acknowledged this broke staging-first workflow)
- Concurrency set to 5 (module default) to prevent Bedrock rate limiting

## Next Steps
1. Check CI on PR #1608, merge to staging with --squash
2. Run `terraform apply` on staging for profile-worker (14 resources to create)
3. Run `terraform apply` on production to update IAM policies (Bedrock model IDs)
4. Test single SQS message on production — should succeed end-to-end now
5. Run full batch: `bmx-api --prod POST /entity/profiles/generate-all`
6. Promote staging → main when ready
7. Close issues #1605 (with process note), #1606, #1607

## Open Questions
- Should we add a CI step to detect terraform drift (new resources) and warn before deploy?
- The 13 uncommitted files (docs/plans, docs/session) need cleanup or .gitignore

## Production State
- Profile worker Lambda: has layer (manually attached), concurrency=5 (applied via terraform)
- Bedrock IAM: still BROKEN (only has Sonnet/Opus wildcards, missing Haiku) — needs terraform apply after PR merge
- SQS queue: purged (was purged after failed batch)
- EBB (author:31): profile generated successfully via synchronous endpoint
- Wordsworth (author:1): profile NOT generated (SQS attempt failed due to IAM)

## Commits on fix/profile-worker-bedrock-iam
- `88a0bdd1` — fix: add Haiku model to worker Lambda Bedrock IAM policies (#1606)
- `08080a45` — fix: extract Bedrock model IDs to locals, fix all worker IAM policies

## Commits on staging (from earlier this session)
- `7056015f` — fix: set profile-worker Lambda concurrency to 5

---

## CRITICAL REMINDERS FOR NEXT SESSION

### Superpowers Skills - MANDATORY
Continue using these skills at ALL stages:
- `superpowers:executing-plans` - continuing plan execution
- `superpowers:verification-before-completion` - before claiming done
- `superpowers:finishing-a-development-branch` - for PR workflow
- `bmx-review-changes` - before creating PRs
- `bmx-apply-review-feedback` - for applying review fixes
- Context7 MCP - for library questions
- Sequential-Thinking MCP - for complex reasoning

### Staging-First Workflow
- ALL changes go through staging first — do NOT apply terraform directly to production
- Merge PR #1608 → staging, then terraform apply staging, then promote, then terraform apply prod

### Production Hotfixes Already Applied
- Layer manually attached to profile-worker Lambda
- Concurrency set to 5 via terraform apply
- Bedrock IAM still needs fix (waiting on PR #1608)
