# FMV Scraper and Opus Production Fixes Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Fix two production-only issues: FMV comparables missing due to wrong scraper Lambda targeting (#718) and Opus model access denied (#719).

**Architecture:** Both issues are production-only - staging environment is unaffected. The FMV fix is code already written and ready to deploy. The Opus fix requires AWS Console access to re-enable model access.

**Tech Stack:** Python (FastAPI backend), AWS Lambda, AWS Bedrock, Terraform

---

## Pre-Implementation Findings

### Issue #718: FMV Comparables Missing (Production-Only)

| Environment | `ENVIRONMENT` var | `get_scraper_environment()` result | Bug present? |
|-------------|-------------------|-----------------------------------|--------------|
| Staging | `staging` | `staging` (correct) | No |
| Production | `prod` | `staging` (WRONG) | **Yes** |

**Root Cause:** `get_scraper_environment()` checks `BMX_SCRAPER_ENVIRONMENT` → `BMX_ENVIRONMENT` → defaults to `"staging"`. It doesn't check `ENVIRONMENT` which is set to `prod` in production Lambda.

**Fix Applied:** Branch `fix/fmv-scraper-environment` adds `ENVIRONMENT` to the fallback chain.

### Issue #719: Opus AccessDeniedException (Production-Only)

| Environment | AWS Account | Opus async job status | Error |
|-------------|-------------|----------------------|-------|
| Staging | 652617421195 | `completed` | None |
| Production | 266672885920 | `failed` | `AccessDeniedException: aws-marketplace:ViewSubscriptions` |

**Evidence from CloudWatch logs:**

| Job ID | Environment | Book | Model | Outcome | Timestamp (UTC) |
|--------|-------------|------|-------|---------|-----------------|
| `a975f44f` | Staging | 538 | opus | SUCCESS | 04:59:23 |
| `d87d1067` | Production | 553 | opus | FAILED | 05:34:19 |
| `fb99b78c` | Production | 553 | sonnet | SUCCESS | 05:54:44 |

**Key Clarification:** The previous session's "successful Opus run" was in **staging** (book 538), not production. The production book 553 analysis showing `generated_at: 2025-12-31T05:49:28` was generated by **Sonnet**, not Opus.

**Root Cause:** Bedrock Model Access is configured **per-region** within each AWS account. Production account (266672885920) has Opus 4.5 enabled in **us-east-2** but NOT in **us-west-2** where the Lambda runs.

| Account | Region | Opus 4.5 Status |
|---------|--------|-----------------|
| Staging (652617421195) | us-west-2 | Enabled ✓ |
| Production (266672885920) | us-west-2 | **NOT enabled** ✗ |
| Production (266672885920) | us-east-2 | Enabled ✓ |

**Fix Required:** Enable Claude Opus 4.5 in AWS Console → Bedrock → Model Access in **production** account, **us-west-2 region**.

---

## Task 1: Push FMV Fix and Create PR to Staging

**Files:**
- Branch: `fix/fmv-scraper-environment` (commit `6177fcb`)
- Modified: `backend/app/config.py:155-169`

**Step 1: Push the branch**

Run from `/Users/mark/projects/bluemoxon`:
```bash
git push -u origin fix/fmv-scraper-environment
```

**Step 2: Create PR to staging**

```bash
gh pr create --base staging --title "fix(config): check ENVIRONMENT env var for scraper Lambda targeting (#718)" --body "$(cat <<'EOF'
## Summary
- Add `ENVIRONMENT` env var check to `get_scraper_environment()` fallback chain
- Fixes production eval worker calling staging scraper Lambda instead of production scraper

## Root Cause
Production Lambda has `ENVIRONMENT=prod` but old code didn't check this env var:
```python
# OLD - falls back to "staging" in production
return os.getenv("BMX_SCRAPER_ENVIRONMENT") or os.getenv("BMX_ENVIRONMENT") or "staging"

# NEW - checks ENVIRONMENT before defaulting
return os.getenv("BMX_SCRAPER_ENVIRONMENT") or os.getenv("BMX_ENVIRONMENT") or os.getenv("ENVIRONMENT", "staging")
```

## Test Plan
- [ ] CI passes
- [ ] Staging deploy succeeds
- [ ] Validate FMV lookup works in staging (no change expected - staging already works)
- [ ] Promote to production
- [ ] Regenerate eval runbook for a production book and verify comparables appear

Fixes #718
EOF
)"
```

**Step 3: Wait for CI to pass**

```bash
gh pr checks --watch
```
Expected: All checks pass (this is a minimal code change)

**Step 4: Merge to staging**

```bash
gh pr merge --squash --delete-branch
```

**Step 5: Commit tracking**

Note PR number for next task.

---

## Task 2: Validate Staging Deploy

**Step 1: Watch deploy workflow**

```bash
gh run list --workflow deploy-staging.yml --limit 1
gh run watch <run-id> --exit-status
```
Expected: Deploy completes successfully

**Step 2: Verify staging API is healthy**

```bash
bmx-api GET /health/deep
```
Expected: `{"status": "healthy", ...}`

**Step 3: Verify the fix is deployed (check environment resolution)**

This is informational - staging was already working. The code change doesn't affect staging behavior.

---

## Task 3: Promote to Production

**Step 1: Create promotion PR**

```bash
gh pr create --base main --head staging --title "chore: Promote staging to production (FMV scraper fix #718)"
```

**Step 2: Wait for CI to pass**

```bash
gh pr checks --watch
```

**Step 3: Merge to production**

```bash
gh pr merge --squash
```

**Step 4: Watch production deploy**

```bash
gh run list --workflow Deploy --limit 1
gh run watch <run-id> --exit-status
```
Expected: Deploy completes, smoke tests pass

---

## Task 4: Validate FMV Fix in Production

**Step 1: Regenerate eval runbook for test book**

```bash
bmx-api --prod POST /books/553/eval-runbook/generate
```
Expected: 200 OK with new eval runbook

**Step 2: Check eval runbook for comparables**

```bash
bmx-api --prod GET /books/553/eval-runbook
```
Expected: `ebay_comparables` and/or `abebooks_comparables` arrays contain listings (not empty)

**Step 3: If comparables still empty**

Check CloudWatch logs for scraper invocation:
```bash
AWS_PROFILE=bmx-prod aws logs filter-log-events --log-group-name /aws/lambda/bluemoxon-prod-eval-runbook-worker --start-time $(date -v-10M +%s000) --limit 20
```

Look for:
- No more `AccessDeniedException` for staging scraper Lambda
- Successful scraper invocation to `bluemoxon-prod-scraper`

---

## Task 5: Fix Opus Model Access (AWS Console - Manual)

**This task requires AWS Console access and cannot be automated.**

**Important:** This fix is for the **production** AWS account (266672885920), not staging (652617421195). Staging already has Opus enabled.

**Step 1: Navigate to Bedrock Model Access**

1. Log into AWS Console with **production** account credentials (account ID: 266672885920)
2. Navigate to: **Amazon Bedrock** → **Model access** (left sidebar)
3. Region: **us-west-2** (Oregon)

**Step 2: Check Claude Opus 4.5 status**

Look for: `anthropic.claude-opus-4-5-20251101-v1:0` or cross-region inference variant

Status should show either:
- "Access required" - needs to be enabled
- "Access granted" - should work, investigate further
- "Subscription required" - AWS Marketplace action needed

**Step 3: Enable access**

If not enabled:
1. Click "Manage model access"
2. Find Claude Opus 4.5 in the list
3. Check the checkbox
4. Click "Request model access"
5. Wait for status to change to "Access granted"

**Step 4: Verify fix**

```bash
bmx-api --prod POST /books/553/analysis/generate-async '{"model": "opus"}'
```

Wait 3-5 minutes, then:
```bash
bmx-api --prod GET /books/553/analysis/status
```
Expected: `status: "completed"` (not "failed")

---

## Task 6: Regenerate Affected Eval Runbooks

**After FMV fix is deployed to production, regenerate eval runbooks for books that were affected.**

**Step 1: Identify affected books**

Books with:
- `has_eval_runbook: true`
- `fmv_notes: "No comparable listings found"` or empty comparables

```bash
bmx-api --prod GET '/books?limit=100&has_eval_runbook=true'
```

**Step 2: Regenerate runbooks for affected books**

For each affected book ID:
```bash
bmx-api --prod POST /books/{id}/eval-runbook/generate
```

**Step 3: Verify comparables appear**

```bash
bmx-api --prod GET /books/{id}/eval-runbook
```
Check that `ebay_comparables` or `abebooks_comparables` contain listings.

---

## Verification Checklist

- [ ] FMV fix PR merged to staging
- [ ] FMV fix promoted to production
- [ ] Production eval runbook generation includes comparables
- [ ] Opus model access enabled in production Bedrock
- [ ] Opus analysis jobs complete successfully in production
- [ ] Affected eval runbooks regenerated

---

## Rollback Plan

**If FMV fix causes issues:**
```bash
git revert <commit-sha>
gh pr create --base staging --title "revert: FMV scraper fix"
```

**If Opus fix causes issues:**
AWS Marketplace access can be revoked via Bedrock Model Access console, but there's no reason to expect issues - this just enables a model that was previously working.
