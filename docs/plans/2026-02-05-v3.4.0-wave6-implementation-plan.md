# v3.4.0 Wave 6: New Issues Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Fix 5 issues — model display labels, checkbox hit areas, timeline year overlap, connection type colors/grouping, and connection detail sidebar on entity profiles.

**Architecture:** Wave 1 has 4 parallel tracks (different files). Wave 2 has 1 dependent track (#1846 depends on #1847 since both modify FilterPanel.vue). All changes are frontend-heavy with one backend tweak.

**Tech Stack:** Vue 3, TypeScript, Cytoscape.js, Python/FastAPI (backend model config)

---

## Wave 1: Four Parallel Tracks

| Track | Issue | Files | What |
|-------|-------|-------|------|
| **A** | #1842 | `bedrock.py`, `admin.py`, `cost_explorer.py`, `AnalysisSection.vue`, `AnalysisViewer.vue` | Config-driven model display names |
| **B** | #1847 | `FilterPanel.vue` | Fix checkbox click areas |
| **C** | #1848 | New `ConnectionDetailSidebar.vue`, `KeyConnections.vue` | Connection detail sidebar on entity profiles |
| **D** | #1825 | `TimelineSlider.vue`, `TimelineMarkers.vue` | Fix year label overlap on timeline |

### Conflict Zones
- **#1847 vs #1846:** Both modify `FilterPanel.vue`. Run #1847 (Wave 1) before #1846 (Wave 2).
- All other tracks: zero file conflicts.

---

### Task 1: Track A — Config-Driven Model Display Names (#1842)

**Files:**
- Modify: `backend/app/services/bedrock.py:96-107` (add MODEL_DISPLAY_NAMES)
- Modify: `backend/app/api/v1/admin.py:106-110, 492-494` (expose model_labels)
- Modify: `backend/app/services/cost_explorer.py:26-42` (derive from MODEL_DISPLAY_NAMES)
- Modify: `frontend/src/components/book-detail/AnalysisSection.vue:23-27` (fetch labels from API)
- Modify: `frontend/src/components/books/AnalysisViewer.vue:304-305, 435-438` (fetch labels + fix comments)
- Modify: `scripts/safe-commit.sh:84` (co-author → Opus 4.6)
- Modify: `infra/terraform/modules/analysis-worker/main.tf:232` (remove version from comment)
- Modify: `infra/terraform/modules/profile-worker/main.tf:232` (remove version from comment)
- Modify: `infra/terraform/modules/lambda/main.tf:238` (remove version from comment)
- Modify: `docs/ADMIN_DASHBOARD.md:74-76` (update model table)
- Modify: `docs/BEDROCK.md:26, 195, 206, 237` (update model refs)
- Modify: `docs/ARCHITECTURE.md:46, 72, 295` (make version-agnostic: "Claude" not "Claude 4.5")
- Modify: `docs/API_REFERENCE.md:419, 1944-1946` (update example output)

**Context:**
Model version strings ("Opus 4.5", "Sonnet 4.5", "Haiku 3.5") are hardcoded across **14 files** — frontend dropdowns, backend cost explorer, Terraform comments, and 4 doc files. Every model bump requires a scavenger hunt. The fix: create a single `MODEL_DISPLAY_NAMES` dict in bedrock.py as the source of truth. Frontend reads labels from API. Backend cost_explorer derives from the same dict. Terraform and doc comments become version-agnostic ("Bedrock model" not "Opus 4.5") so they never go stale.

**Step 1: Add MODEL_DISPLAY_NAMES to bedrock.py**

After `MODEL_USAGE` dict (line 107), add:

```python
# Human-readable display names derived from model IDs.
# Single source of truth — frontend reads these via /admin/model-config.
MODEL_DISPLAY_NAMES = {
    "sonnet": "Sonnet 4.5",
    "opus": "Opus 4.6",
    "haiku": "Haiku 3.5",
}
```

**Step 2: Expose in admin API response**

In `backend/app/api/v1/admin.py`, update the `ModelConfigResponse` schema (line 106):

```python
class ModelConfigResponse(BaseModel):
    """Response for model configuration endpoint."""

    flows: list[ModelConfigFlow]
    available_models: list[str]
    model_labels: dict[str, str]  # ADD: {"opus": "Opus 4.6", ...}
```

Update the return value in `get_model_config()` (line 492):

```python
from app.services.bedrock import MODEL_IDS, MODEL_DISPLAY_NAMES

return ModelConfigResponse(
    flows=flows,
    available_models=list(MODEL_IDS.keys()),
    model_labels=MODEL_DISPLAY_NAMES,  # ADD
)
```

**Step 3: Fix cost_explorer.py — derive from MODEL_DISPLAY_NAMES**

In `backend/app/services/cost_explorer.py`, import and use the single source of truth.
Replace the hardcoded `MODEL_USAGE_DESCRIPTIONS` (lines 36-43):

```python
from app.services.bedrock import MODEL_DISPLAY_NAMES, MODEL_USAGE

# Build from MODEL_DISPLAY_NAMES so model bumps auto-propagate
MODEL_USAGE_DESCRIPTIONS = {
    display: MODEL_USAGE.get(key, "Analysis")
    for key, display in MODEL_DISPLAY_NAMES.items()
}
# Legacy models (no longer in MODEL_IDS) — static, won't change
MODEL_USAGE_DESCRIPTIONS["Sonnet 3.5"] = "Legacy analysis"
MODEL_USAGE_DESCRIPTIONS["Sonnet 3.5 v2"] = "Legacy analysis"
```

Also update `MODEL_NAME_MAP` (lines 25-33) to derive current models:

```python
from app.services.bedrock import MODEL_DISPLAY_NAMES

MODEL_NAME_MAP = {
    # Current models — derive from MODEL_DISPLAY_NAMES
    **{f"Claude {display} (Amazon Bedrock Edition)": display for display in MODEL_DISPLAY_NAMES.values()},
    # Legacy models — static
    "Claude 3 Haiku (Amazon Bedrock Edition)": "Haiku 3.5",
    "Claude 3.5 Haiku (Amazon Bedrock Edition)": "Haiku 3.5",
    "Claude 3.5 Sonnet (Amazon Bedrock Edition)": "Sonnet 3.5",
    "Claude 3.5 Sonnet v2 (Amazon Bedrock Edition)": "Sonnet 3.5 v2",
}
```

**Note:** The AWS billing name format needs verification. Check the test at `backend/tests/test_cost_explorer.py` to see what AWS actually returns. The derived names may need the exact billing string, which could differ from the display name. If so, add a `MODEL_BILLING_NAMES` dict to bedrock.py.

**Step 3b: Fix safe-commit.sh**

In `scripts/safe-commit.sh`, update line 84:
```bash
Co-Authored-By: Claude Opus 4.6 <noreply@anthropic.com>"
```

**Step 3c: Make Terraform comments version-agnostic**

Remove version numbers from comments so they never go stale:

`infra/terraform/modules/analysis-worker/main.tf:232`:
```hcl
        # Required for Bedrock model access verification at runtime
```

`infra/terraform/modules/profile-worker/main.tf:232`:
```hcl
        # Required for Bedrock model access verification at runtime
```

`infra/terraform/modules/lambda/main.tf:238`:
```hcl
        # Required for Bedrock model access verification at runtime
```

**Step 3d: Fix docs — ADMIN_DASHBOARD.md**

Update `docs/ADMIN_DASHBOARD.md` lines 74-76:
```markdown
| Model | Typical Usage |
|-------|---------------|
| **Sonnet 4.5** | Primary book analysis |
| **Opus 4.6** | Complex reasoning tasks |
| **Haiku 3.5** | Fast extraction tasks |
```

**Step 3e: Fix docs — BEDROCK.md**

Update `docs/BEDROCK.md`:
- Line 26: `# Invoke Claude Sonnet` (remove version)
- Line 195: Update table header to current versions
- Line 206: `If Claude requests hang indefinitely:` (remove version)
- Line 237: `- Claude output limit: ~8000 tokens typical` (remove version)

**Step 3f: Fix docs — ARCHITECTURE.md**

Make version-agnostic in `docs/ARCHITECTURE.md`:
- Line 46: `│ (Claude via Bedrock) │` (remove "4.5")
- Line 72: `| AI Analysis | AWS Bedrock (Claude) | Napoleon Framework valuations via managed Claude models |`
- Line 295: `Bedrock["AWS Bedrock<br/>(Claude)"]`

**Step 3g: Fix docs — API_REFERENCE.md**

Update example output in `docs/API_REFERENCE.md`:
- Line 419: `generated using **AWS Bedrock (Claude)** with the **Napoleon Framework** prompt,`
- Lines 1944-1946: Update example model names to current versions

**Step 4: Update AnalysisSection.vue to use API labels**

In `frontend/src/components/book-detail/AnalysisSection.vue`, replace the hardcoded `modelOptions` (lines 23-27):

```vue
// Fetch model labels from API (config-driven, not hardcoded)
const modelLabels = ref<Record<string, string>>({
  opus: "Opus",
  sonnet: "Sonnet",
});

// Load labels on mount
onMounted(async () => {
  try {
    const resp = await api.get("/admin/model-config");
    if (resp.data?.model_labels) {
      modelLabels.value = resp.data.model_labels;
    }
  } catch {
    // Silently fall back to defaults — non-admin users can't access this endpoint
  }
});

const modelOptions = computed(() =>
  Object.entries(modelLabels.value).map(([value, label]) => ({ value, label }))
);
```

Add the missing imports (`onMounted`, `computed`). Check existing imports first — these may already be imported.

**Step 5: Update AnalysisViewer.vue dropdown**

In `frontend/src/components/books/AnalysisViewer.vue`, replace the hardcoded `<option>` elements (lines 435-438):

```vue
<select
  v-model="selectedModel"
  class="select text-sm w-32 pr-8 bg-[var(--color-surface-primary)] text-[var(--color-text-primary)]"
  :disabled="generating"
>
  <option v-for="(label, key) in modelLabels" :key="key" :value="key">
    {{ label }}
  </option>
</select>
```

Add the same `modelLabels` ref and API fetch pattern as AnalysisSection.vue. Check if this component already fetches model config — if so, extend the existing fetch.

**Step 6: Run validation**

```bash
poetry run ruff check backend/
npm run --prefix frontend lint
npm run --prefix frontend type-check
```

**Step 7: Commit**

```bash
git add backend/app/services/bedrock.py backend/app/api/v1/admin.py backend/app/services/cost_explorer.py frontend/src/components/book-detail/AnalysisSection.vue frontend/src/components/books/AnalysisViewer.vue scripts/safe-commit.sh infra/terraform/modules/analysis-worker/main.tf infra/terraform/modules/profile-worker/main.tf infra/terraform/modules/lambda/main.tf docs/ADMIN_DASHBOARD.md docs/BEDROCK.md docs/ARCHITECTURE.md docs/API_REFERENCE.md
git commit -m "fix: single source of truth for model display names (#1842)

Add MODEL_DISPLAY_NAMES to bedrock.py — all other files derive from
it. Frontend reads labels from /admin/model-config API. cost_explorer
builds display names dynamically. Terraform comments and docs made
version-agnostic so they never go stale on model bumps."
```

---

### Task 2: Track B — Fix Checkbox Click Areas (#1847)

**Files:**
- Modify: `frontend/src/components/socialcircles/FilterPanel.vue:170-264` (template), `363-365` (CSS)

**Context:**
Every checkbox in the filter panel uses `@click.prevent` on the `<label>` element. This prevents the native checkbox from toggling when clicked directly. The browser's default behavior for `<label>` is to toggle its associated checkbox on click, but `.prevent` blocks this. Users clicking the checkbox square see nothing happen.

**Fix:** Remove `@click.prevent` from all labels. Move the toggle logic to `@change` on the `<input>` element. This way clicking anywhere in the label (including the checkbox) triggers the native checkbox toggle, which fires `@change`.

**Step 1: Update Node Type checkboxes**

Replace lines 170-216 (all 3 node type labels):

```vue
<!-- Node Types -->
<section class="filter-panel__section">
  <h3 class="filter-panel__section-title">Node Types</h3>
  <label class="filter-panel__checkbox" data-testid="filter-authors">
    <input
      type="checkbox"
      :checked="props.filterState.showAuthors"
      @change="toggleNodeType('showAuthors')"
    />
    <span class="filter-panel__checkbox-indicator filter-panel__checkbox-indicator--author" />
    <span>Authors</span>
    <FilterBadges
      v-if="props.nodes"
      :nodes="props.nodes"
      :filter-state="props.filterState"
      node-type="author"
    />
  </label>
  <label class="filter-panel__checkbox" data-testid="filter-publishers">
    <input
      type="checkbox"
      :checked="props.filterState.showPublishers"
      @change="toggleNodeType('showPublishers')"
    />
    <span class="filter-panel__checkbox-indicator filter-panel__checkbox-indicator--publisher" />
    <span>Publishers</span>
    <FilterBadges
      v-if="props.nodes"
      :nodes="props.nodes"
      :filter-state="props.filterState"
      node-type="publisher"
    />
  </label>
  <label class="filter-panel__checkbox" data-testid="filter-binders">
    <input
      type="checkbox"
      :checked="props.filterState.showBinders"
      @change="toggleNodeType('showBinders')"
    />
    <span class="filter-panel__checkbox-indicator filter-panel__checkbox-indicator--binder" />
    <span>Binders</span>
    <FilterBadges
      v-if="props.nodes"
      :nodes="props.nodes"
      :filter-state="props.filterState"
      node-type="binder"
    />
  </label>
</section>
```

**Step 2: Update Connection Type checkboxes**

Replace lines 222-236:

```vue
<label
  v-for="ct in allConnectionTypes"
  :key="ct"
  class="filter-panel__checkbox"
  :data-testid="`filter-${ct}`"
>
  <input
    type="checkbox"
    :checked="isConnectionTypeActive(ct)"
    @change="toggleConnectionType(ct)"
  />
  <span
    class="filter-panel__connection-color"
    :style="{ backgroundColor: CONNECTION_INFO[ct].color }"
  />
  <span>{{ CONNECTION_INFO[ct].label }}</span>
</label>
```

**Step 3: Update Era checkboxes**

Replace lines 241-251:

```vue
<label
  v-for="era in displayEras"
  :key="era"
  class="filter-panel__checkbox"
  :data-testid="`filter-era-${era}`"
>
  <input type="checkbox" :checked="isEraActive(era)" @change="toggleEra(era)" />
  <span>{{ ERA_INFO[era].label }}</span>
  <span class="filter-panel__era-range">{{ ERA_INFO[era].range }}</span>
</label>
```

**Step 4: Update Tier checkbox**

Replace lines 257-264:

```vue
<label class="filter-panel__checkbox" data-testid="filter-tier1">
  <input
    type="checkbox"
    :checked="props.filterState.tier1Only"
    @change="toggleTier1Only"
  />
  <span>Tier 1 Only</span>
</label>
```

**Step 5: Run lint + type-check**

```bash
npm run --prefix frontend lint
npm run --prefix frontend type-check
```

**Step 6: Run existing FilterPanel tests**

```bash
npm run --prefix frontend test -- --run FilterPanel
```

Check that existing tests pass. If tests click labels via `data-testid`, they should still work because `<label>` click triggers `<input>` change.

**Step 7: Commit**

```bash
git add frontend/src/components/socialcircles/FilterPanel.vue
git commit -m "fix: checkbox click areas in filter panel (#1847)

Move toggle handlers from @click.prevent on <label> to @change on
<input>. Clicking anywhere in the label — including the checkbox
square — now correctly toggles the filter."
```

---

### Task 3: Track C — Connection Detail Sidebar (#1848)

**Files:**
- Create: `frontend/src/components/entityprofile/ConnectionDetailSidebar.vue`
- Modify: `frontend/src/components/entityprofile/KeyConnections.vue:20-27, 34-38`

**Context:**
Clicking a connection in KeyConnections on the entity profile page should open a detail sidebar similar to EdgeSidebar in Social Circles. `ProfileConnection` has MORE data than `ApiEdge` (full `shared_books` array, `relationship_story`, `sub_type`, `confidence`), so no additional API calls are needed.

**Step 1: Create ConnectionDetailSidebar.vue**

Create `frontend/src/components/entityprofile/ConnectionDetailSidebar.vue`:

```vue
<script setup lang="ts">
import { computed, watch, nextTick, ref } from "vue";
import type { ProfileConnection } from "@/types/entityProfile";
import { bookDetailRoute, entityProfileRoute } from "@/utils/routes";
import ConditionBadge from "./ConditionBadge.vue";
import ConnectionGossipPanel from "./ConnectionGossipPanel.vue";
import EntityLinkedText from "./EntityLinkedText.vue";

const props = defineProps<{
  connection: ProfileConnection | null;
  /** All connections for EntityLinkedText cross-referencing */
  allConnections: ProfileConnection[];
  isOpen: boolean;
}>();

const emit = defineEmits<{
  close: [];
}>();

const sidebarRef = ref<HTMLElement | null>(null);

// Focus trap on open
watch(
  () => props.isOpen,
  async (open) => {
    if (open) {
      await nextTick();
      sidebarRef.value?.focus();
    }
  },
);

function handleKeydown(e: KeyboardEvent) {
  if (e.key === "Escape") {
    emit("close");
  }
}

const connectionLabel = computed(() => {
  if (!props.connection) return "";
  return props.connection.connection_type.replace(/_/g, " ");
});

const strengthDots = computed(() => {
  if (!props.connection) return 0;
  return Math.ceil(props.connection.strength / 2);
});
</script>

<template>
  <Teleport to="body">
    <Transition name="sidebar-slide">
      <aside
        v-if="isOpen && connection"
        ref="sidebarRef"
        class="connection-sidebar"
        tabindex="-1"
        role="complementary"
        aria-label="Connection details"
        @keydown="handleKeydown"
      >
        <div class="connection-sidebar__header">
          <div class="connection-sidebar__header-content">
            <router-link
              :to="entityProfileRoute(connection.entity.type, connection.entity.id)"
              class="connection-sidebar__entity-name"
            >
              {{ connection.entity.name }}
            </router-link>
            <div class="connection-sidebar__type-row">
              <span class="connection-sidebar__type">{{ connectionLabel }}</span>
              <span v-if="connection.sub_type" class="connection-sidebar__sub-type">
                {{ connection.sub_type }}
              </span>
              <span v-if="connection.is_ai_discovered" class="connection-sidebar__ai-badge">
                AI
              </span>
            </div>
          </div>
          <button
            class="connection-sidebar__close"
            aria-label="Close sidebar"
            @click="emit('close')"
          >
            &times;
          </button>
        </div>

        <div class="connection-sidebar__body">
          <!-- Strength -->
          <div class="connection-sidebar__strength">
            <span class="connection-sidebar__strength-label">Strength</span>
            <span class="connection-sidebar__dots">
              <span
                v-for="i in 5"
                :key="i"
                :class="i <= strengthDots ? '--filled' : '--empty'"
              >&bull;</span>
            </span>
            <span v-if="connection.confidence !== undefined" class="connection-sidebar__confidence">
              {{ Math.round(connection.confidence * 100) }}% confidence
            </span>
          </div>

          <!-- Narrative -->
          <section v-if="connection.narrative" class="connection-sidebar__narrative">
            <p class="connection-sidebar__evidence">
              <EntityLinkedText
                :text="connection.narrative"
                :connections="allConnections"
              />
            </p>
          </section>

          <!-- Shared Books -->
          <section
            v-if="connection.shared_books.length"
            class="connection-sidebar__books"
          >
            <h4 class="connection-sidebar__section-title">
              {{ connection.shared_book_count }}
              {{ connection.shared_book_count === 1 ? "Shared Book" : "Shared Books" }}
            </h4>
            <ul class="connection-sidebar__book-list">
              <li
                v-for="book in connection.shared_books"
                :key="book.id"
                class="connection-sidebar__book-item"
              >
                <img
                  v-if="book.primary_image_url"
                  :src="book.primary_image_url"
                  :alt="book.title"
                  loading="lazy"
                  class="connection-sidebar__book-thumb"
                />
                <div class="connection-sidebar__book-info">
                  <router-link
                    :to="bookDetailRoute(book.id)"
                    class="connection-sidebar__book-title"
                  >
                    {{ book.title }}
                  </router-link>
                  <div class="connection-sidebar__book-meta">
                    <span v-if="book.year">{{ book.year }}</span>
                    <ConditionBadge v-if="book.condition" :condition="book.condition" />
                  </div>
                </div>
              </li>
            </ul>
          </section>

          <!-- Relationship Story -->
          <ConnectionGossipPanel
            v-if="connection.relationship_story"
            :narrative="connection.relationship_story"
            :trigger="connection.narrative_trigger"
            :connections="allConnections"
          />
        </div>
      </aside>
    </Transition>
  </Teleport>
</template>

<style scoped>
.connection-sidebar {
  position: fixed;
  top: 0;
  right: 0;
  width: 400px;
  max-width: 90vw;
  height: 100vh;
  background: var(--color-surface, #faf8f5);
  border-left: 1px solid var(--color-border, #e8e4de);
  box-shadow: -4px 0 16px rgb(0 0 0 / 8%);
  z-index: 50;
  display: flex;
  flex-direction: column;
  outline: none;
}

.connection-sidebar__header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  padding: 20px;
  border-bottom: 1px solid var(--color-border, #e8e4de);
  flex-shrink: 0;
}

.connection-sidebar__header-content {
  flex: 1;
  min-width: 0;
}

.connection-sidebar__entity-name {
  font-size: 18px;
  font-weight: 600;
  color: var(--color-accent-gold, #b8860b);
  text-decoration: none;
  display: block;
  margin-bottom: 4px;
}

.connection-sidebar__entity-name:hover {
  text-decoration: underline;
}

.connection-sidebar__type-row {
  display: flex;
  align-items: center;
  gap: 6px;
}

.connection-sidebar__type {
  font-size: 12px;
  text-transform: capitalize;
  color: var(--color-text-secondary, #6b6b6b);
}

.connection-sidebar__sub-type {
  font-size: 11px;
  background: var(--color-surface-secondary, #f0ece6);
  padding: 1px 6px;
  border-radius: 4px;
}

.connection-sidebar__ai-badge {
  font-size: 10px;
  font-weight: 700;
  color: #6366f1;
  background: #eef2ff;
  padding: 1px 5px;
  border-radius: 4px;
}

.connection-sidebar__close {
  background: none;
  border: none;
  font-size: 24px;
  cursor: pointer;
  color: var(--color-text-secondary, #6b6b6b);
  padding: 0 4px;
  line-height: 1;
}

.connection-sidebar__close:hover {
  color: var(--color-text-primary, #1a1a1a);
}

.connection-sidebar__body {
  flex: 1;
  overflow-y: auto;
  padding: 20px;
  display: flex;
  flex-direction: column;
  gap: 20px;
}

.connection-sidebar__strength {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 13px;
}

.connection-sidebar__strength-label {
  color: var(--color-text-secondary, #6b6b6b);
}

.connection-sidebar__dots .--filled {
  color: var(--color-accent-gold, #b8860b);
}

.connection-sidebar__dots .--empty {
  color: var(--color-border, #e8e4de);
}

.connection-sidebar__confidence {
  margin-left: auto;
  font-size: 12px;
  color: var(--color-text-secondary, #6b6b6b);
}

.connection-sidebar__evidence {
  font-style: italic;
  font-size: 14px;
  line-height: 1.6;
  color: var(--color-text-primary, #1a1a1a);
}

.connection-sidebar__section-title {
  font-size: 13px;
  font-weight: 600;
  margin: 0 0 8px;
}

.connection-sidebar__book-list {
  list-style: none;
  padding: 0;
  margin: 0;
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.connection-sidebar__book-item {
  display: flex;
  gap: 10px;
  align-items: flex-start;
}

.connection-sidebar__book-thumb {
  width: 40px;
  height: 56px;
  object-fit: cover;
  border-radius: 2px;
  flex-shrink: 0;
}

.connection-sidebar__book-info {
  min-width: 0;
}

.connection-sidebar__book-title {
  font-size: 13px;
  color: var(--color-accent-gold, #b8860b);
  text-decoration: none;
  display: block;
}

.connection-sidebar__book-title:hover {
  text-decoration: underline;
}

.connection-sidebar__book-meta {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 12px;
  color: var(--color-text-secondary, #6b6b6b);
  margin-top: 2px;
}

/* Slide transition */
.sidebar-slide-enter-active,
.sidebar-slide-leave-active {
  transition: transform 0.25s ease;
}

.sidebar-slide-enter-from,
.sidebar-slide-leave-to {
  transform: translateX(100%);
}
</style>
```

**Step 2: Wire into KeyConnections.vue**

In `frontend/src/components/entityprofile/KeyConnections.vue`, add the sidebar:

Add to the `<script setup>` section:

```vue
import ConnectionDetailSidebar from "./ConnectionDetailSidebar.vue";

const selectedConnection = ref<ProfileConnection | null>(null);
const sidebarOpen = ref(false);

function openConnectionDetail(conn: ProfileConnection) {
  selectedConnection.value = conn;
  sidebarOpen.value = true;
}

function closeSidebar() {
  sidebarOpen.value = false;
}
```

Make each connection card clickable. Add `@click` and `cursor: pointer` to the card div (line 34-38):

```vue
<div
  v-for="conn in connections"
  :key="`${conn.entity.type}:${conn.entity.id}`"
  class="key-connections__card key-connections__card--clickable"
  @click="openConnectionDetail(conn)"
>
```

Add the sidebar component at the bottom of the `<template>`, after `</section>`:

```vue
<ConnectionDetailSidebar
  :connection="selectedConnection"
  :all-connections="connections"
  :is-open="sidebarOpen"
  @close="closeSidebar"
/>
```

Add CSS for the clickable card:

```css
.key-connections__card--clickable {
  cursor: pointer;
  transition: border-color 0.15s ease;
}

.key-connections__card--clickable:hover {
  border-color: var(--color-accent-gold, #b8860b);
}
```

**Step 3: Prevent click propagation on interactive elements**

The card has `<router-link>` elements and buttons inside. Add `@click.stop` on the "View full story" button and router-links to prevent the sidebar from opening when clicking those:

On the entity name link (line 40-45), add `@click.stop`:
```vue
<router-link
  :to="entityProfileRoute(conn.entity.type, conn.entity.id)"
  class="key-connections__name"
  @click.stop
>
```

On the story toggle button (line 94-101), add `@click.stop`:
```vue
<button
  v-if="conn.relationship_story"
  class="key-connections__story-toggle"
  :aria-expanded="isExpanded(conn)"
  @click.stop="toggleCard(conn)"
>
```

On book links (line 72-74), add `@click.stop`:
```vue
<router-link :to="bookDetailRoute(book.id)" class="key-connections__book-link" @click.stop>
```

**Step 4: Run lint + type-check**

```bash
npm run --prefix frontend lint
npm run --prefix frontend type-check
```

**Step 5: Commit**

```bash
git add frontend/src/components/entityprofile/ConnectionDetailSidebar.vue frontend/src/components/entityprofile/KeyConnections.vue
git commit -m "feat: connection detail sidebar on entity profiles (#1848)

Click any connection card to open a detail sidebar showing strength,
narrative, shared books with thumbnails, and relationship story.
Reuses existing ProfileConnection data (no additional API calls)."
```

---

### Task 5: Track D — Timeline Fixes (#1825)

**Files:**
- Modify: `frontend/src/components/socialcircles/TimelineSlider.vue:97-141` (template), `221-226` (CSS)
- Modify: `frontend/src/components/socialcircles/TimelineMarkers.vue:197-203` (CSS)
- Modify: `frontend/src/constants/socialCircles.ts:19-24` (VICTORIAN_EVENTS)
- Modify: `backend/app/services/social_circles.py:41-58` (date range clamping)

**Context:**
Three timeline issues:
1. **Year label overlap:** The slider's current year display (`timeline-slider__current`) sits *below* the track, in the same vertical zone as event marker year labels. When slider position coincides with a marker (e.g., 1837 = Victoria's Coronation), labels collide.
2. **Too few events:** Only 4 events, all Victoria-centric. Need landmarks relevant to book collecting.
3. **maxYear too high:** Backend uses `max(death_years)` which can be 1967 if a late-surviving author is in the data. Should cap at 1950 (end of `post_1910` era range).

#### Part A: Move year display above slider track

**Step 1: Move `__current` div above the track in TimelineSlider.vue**

In the `<template>` section (lines 97-141), move the `timeline-slider__current` div from after `__track` to before it:

```vue
<template>
  <div class="timeline-slider">
    <div class="timeline-slider__controls">
      <div class="timeline-slider__mode">
        <button
          :class="['timeline-slider__mode-btn', { active: mode === 'point' }]"
          @click="emit('mode-change', 'point')"
        >
          Point
        </button>
        <button
          :class="['timeline-slider__mode-btn', { active: mode === 'range' }]"
          @click="emit('mode-change', 'range')"
        >
          Range
        </button>
      </div>

      <button class="timeline-slider__play" @click="handlePlay">
        {{ isPlaying ? "⏸" : "▶" }}
      </button>
    </div>

    <!-- Year display moved ABOVE track to avoid overlapping with marker year labels below -->
    <div class="timeline-slider__current">
      {{ yearLabel }}
    </div>

    <div class="timeline-slider__track">
      <span v-show="showMinLabel" class="timeline-slider__label">{{ minYear }}</span>
      <div class="timeline-slider__input-wrapper">
        <input
          v-model.number="localYear"
          type="range"
          :min="minYear"
          :max="maxYear"
          class="timeline-slider__input"
          aria-label="Timeline year selector"
          @change="updateYear(localYear)"
        />
        <TimelineMarkers :min-year="minYear" :max-year="maxYear" :slider-year="localYear" />
      </div>
      <span v-show="showMaxLabel" class="timeline-slider__label">{{ maxYear }}</span>
    </div>
  </div>
</template>
```

**Step 2: Update CSS in TimelineSlider.vue**

Change `timeline-slider__current` from `margin-top` to `margin-bottom`:

```css
.timeline-slider__current {
  text-align: center;
  font-weight: 600;
  color: var(--color-victorian-hunter-700);
  margin-bottom: 0.5rem;
}
```

**Step 3: Add top offset to TimelineMarkers.vue**

Change `.timeline-markers` top offset to clear the slider thumb (which extends ~6px below the 4px track):

```css
.timeline-markers {
  position: absolute;
  top: calc(100% + 4px);
  left: 0;
  right: 0;
  height: 32px;
}
```

#### Part B: Add historical events

**Step 4: Update VICTORIAN_EVENTS in socialCircles.ts**

Replace the `VICTORIAN_EVENTS` array (lines 19-24):

```typescript
/** Default historical events displayed on the timeline */
export const VICTORIAN_EVENTS = [
  { year: 1837, label: "Victoria's Coronation", type: "political" },
  { year: 1851, label: "Great Exhibition", type: "cultural" },
  { year: 1859, label: "Origin of Species", type: "literary" },
  { year: 1865, label: "Alice in Wonderland", type: "literary" },
  { year: 1891, label: "Kelmscott Press", type: "cultural" },
  { year: 1901, label: "Victoria Dies", type: "political" },
  { year: 1914, label: "World War I", type: "political" },
] as const satisfies readonly HistoricalEvent[];
```

New events rationale:
- **1865 Alice in Wonderland** — one of the most collected Victorian first editions
- **1891 Kelmscott Press** — William Morris; ignited the private press movement central to fine book collecting
- **1914 World War I** — definitive end of Edwardian era; collection boundary marker

Spacing: `1837 · 1851 · 1859 · 1865 · 1891 · 1901 · 1914` — minimum gap 6 years, handled by existing `MIN_LABEL_PX` label-hiding logic.

#### Part C: Cap maxYear at collection boundary

**Step 5: Add COLLECTION_MAX_YEAR clamp in social_circles.py**

Update `backend/app/services/social_circles.py` lines 41-58:

```python
# Reasonable year bounds for clamping outliers in date range calculation.
# Authors with birth/death years outside this range are likely data errors.
REASONABLE_MIN_YEAR = 1700
# Static upper bound — intentionally not dynamic. This Victorian-era collection
# has no living subjects, so a fixed ceiling avoids unnecessary complexity.
REASONABLE_MAX_YEAR = 2025

# Collection-era bounds — timeline should not extend beyond the collection's scope.
# Matches ERA_RANGES post_1910 upper bound in frontend socialCircles.ts.
COLLECTION_MIN_YEAR = 1700
COLLECTION_MAX_YEAR = 1950


def _compute_date_range(years: list[int]) -> tuple[int, int]:
    """Compute date range from years, filtering outliers outside reasonable bounds.

    After filtering unreasonable years, clamps the result to the collection era
    (1700-1950) so the timeline never extends beyond the collection's scope.
    """
    if not years:
        return DEFAULT_DATE_RANGE

    reasonable = [y for y in years if REASONABLE_MIN_YEAR <= y <= REASONABLE_MAX_YEAR]
    if not reasonable:
        return DEFAULT_DATE_RANGE

    return (
        max(min(reasonable), COLLECTION_MIN_YEAR),
        min(max(reasonable), COLLECTION_MAX_YEAR),
    )
```

#### Part D: Validate and commit

**Step 6: Run validation**

```bash
poetry run ruff check backend/
npm run --prefix frontend lint
npm run --prefix frontend type-check
```

**Step 7: Commit**

```bash
git add frontend/src/components/socialcircles/TimelineSlider.vue frontend/src/components/socialcircles/TimelineMarkers.vue frontend/src/constants/socialCircles.ts backend/app/services/social_circles.py
git commit -m "fix: timeline year overlap, add events, cap maxYear at 1950 (#1825)

Move year display above slider track to prevent overlap with event
marker labels below. Add Alice in Wonderland (1865), Kelmscott Press
(1891), and WWI (1914) as timeline events. Clamp _compute_date_range()
to COLLECTION_MAX_YEAR=1950 so timeline stays within collection scope."
```

---

## Wave 2: Connection Type Reorg (depends on Wave 1 Track B)

### Task 4: Recategorize Connection Types + New Colors (#1846)

**Files:**
- Modify: `frontend/src/constants/socialCircles.ts:72-84, 124-135`
- Modify: `frontend/src/components/socialcircles/FilterPanel.vue:19-31, 220-236`
- Modify: `frontend/src/components/socialcircles/ConnectionTooltip.vue` (descriptions)
- Modify: `frontend/src/components/socialcircles/EdgeSidebar.vue:68-83` (labels)

**Context:**
Currently all AI-discovered types except scandal share the same blue (#60a5fa). The user wants:
- **Personal:** family, friendship, scandal — warm tones
- **Professional:** collaboration, influence — distinct colors

**Step 1: Update EDGE_COLORS in socialCircles.ts**

Replace `EDGE_COLORS` (lines 72-84):

```typescript
export const EDGE_COLORS: Record<ConnectionType, string> = {
  // Book-based connections
  publisher: "#4ade80",        // green
  shared_publisher: "#4ade80", // green
  binder: "#a78bfa",          // purple
  // Personal connections (warm tones)
  family: "#60a5fa",          // blue
  friendship: "#38bdf8",      // sky blue
  scandal: "#f87171",         // red
  // Professional connections (warm earth tones)
  collaboration: "#fb923c",   // orange
  influence: "#fbbf24",       // amber
};
```

**Step 2: Update EDGE_STYLES in socialCircles.ts**

Update comments in `EDGE_STYLES` (lines 124-135) to reflect categories:

```typescript
export const EDGE_STYLES: Record<ConnectionType, { lineStyle: string; opacity: number }> = {
  // Book-based connections
  publisher: { lineStyle: "solid", opacity: 0.8 },
  shared_publisher: { lineStyle: "solid", opacity: 0.6 },
  binder: { lineStyle: "dashed", opacity: 0.5 },
  // Personal connections
  family: { lineStyle: "solid", opacity: 0.8 },
  friendship: { lineStyle: "solid", opacity: 0.7 },
  scandal: { lineStyle: "dashed", opacity: 0.8 },
  // Professional connections
  influence: { lineStyle: "dotted", opacity: 0.7 },
  collaboration: { lineStyle: "solid", opacity: 0.7 },
};
```

**Step 3: Update FilterPanel.vue — colors + grouping**

Update `CONNECTION_INFO` (lines 20-31) with new colors:

```typescript
const CONNECTION_INFO: Record<ConnectionType, { label: string; color: string; category: string }> = {
  // Book-based connections
  publisher: { label: "Published By", color: "#4ade80", category: "Book-Based" },
  shared_publisher: { label: "Shared Publisher", color: "#4ade80", category: "Book-Based" },
  binder: { label: "Same Bindery", color: "#a78bfa", category: "Book-Based" },
  // Personal connections
  family: { label: "Family", color: "#60a5fa", category: "Personal" },
  friendship: { label: "Friendship", color: "#38bdf8", category: "Personal" },
  scandal: { label: "Scandal", color: "#f87171", category: "Personal" },
  // Professional connections
  collaboration: { label: "Collaboration", color: "#fb923c", category: "Professional" },
  influence: { label: "Influence", color: "#fbbf24", category: "Professional" },
};
```

Update `allConnectionTypes` to be grouped:

```typescript
const connectionGroups = [
  {
    title: "Book-Based",
    types: ["publisher", "shared_publisher", "binder"] as ConnectionType[],
  },
  {
    title: "Personal",
    types: ["family", "friendship", "scandal"] as ConnectionType[],
  },
  {
    title: "Professional",
    types: ["collaboration", "influence"] as ConnectionType[],
  },
];
```

Replace the flat connection list template (lines 220-236) with grouped rendering:

```vue
<!-- Connection Types -->
<section class="filter-panel__section">
  <h3 class="filter-panel__section-title">Connections</h3>
  <div
    v-for="group in connectionGroups"
    :key="group.title"
    class="filter-panel__connection-group"
  >
    <span class="filter-panel__group-label">{{ group.title }}</span>
    <label
      v-for="ct in group.types"
      :key="ct"
      class="filter-panel__checkbox"
      :data-testid="`filter-${ct}`"
    >
      <input
        type="checkbox"
        :checked="isConnectionTypeActive(ct)"
        @change="toggleConnectionType(ct)"
      />
      <span
        class="filter-panel__connection-color"
        :style="{ backgroundColor: CONNECTION_INFO[ct].color }"
      />
      <span>{{ CONNECTION_INFO[ct].label }}</span>
    </label>
  </div>
</section>
```

Add CSS for the group label:

```css
.filter-panel__connection-group {
  margin-bottom: 0.5rem;
}

.filter-panel__group-label {
  display: block;
  font-size: 0.7rem;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  color: var(--color-victorian-ink-muted, #5c5c58);
  margin-bottom: 0.25rem;
  margin-top: 0.5rem;
}

.filter-panel__connection-group:first-child .filter-panel__group-label {
  margin-top: 0;
}
```

**Step 4: Update EdgeSidebar.vue labels**

In `EdgeSidebar.vue` (lines 68-83), update the `connectionLabel` computed to add category context:

```typescript
const connectionLabel = computed(() => {
  if (!props.edge) return "";
  const labels: Record<ConnectionType, string> = {
    publisher: "Published together",
    shared_publisher: "Shared Publisher",
    binder: "Bound works",
    family: "Family",
    friendship: "Friends",
    influence: "Influence",
    collaboration: "Collaborators",
    scandal: "Scandal",
  };
  return labels[props.edge.type];
});
```

No changes needed here — labels are already correct. Just verify the colors display correctly in the sidebar's connection type indicator if one exists.

**Step 5: Run validation**

```bash
npm run --prefix frontend lint
npm run --prefix frontend type-check
npm run --prefix frontend test -- --run FilterPanel
```

**Step 6: Commit**

```bash
git add frontend/src/constants/socialCircles.ts frontend/src/components/socialcircles/FilterPanel.vue frontend/src/components/socialcircles/ConnectionTooltip.vue frontend/src/components/socialcircles/EdgeSidebar.vue
git commit -m "feat: categorize connection types with distinct colors (#1846)

Split connections into Book-Based, Personal (family/friendship/scandal),
and Professional (collaboration/influence). Give each AI type a distinct
color instead of uniform blue. Group in filter panel with sub-headers."
```

---

## Wave 3: Validation + Ship

### Step 1: Full validation

```bash
# Backend
poetry run ruff check backend/
poetry run ruff format --check backend/
poetry run pytest backend/tests/ -v

# Frontend
npm run --prefix frontend lint
npm run --prefix frontend format
npm run --prefix frontend type-check
npm run --prefix frontend test -- --run
```

### Step 2: Review

Use `/review-changes` on the combined diff.

### Step 3: Close issues

```bash
gh issue close 1842 -c "Resolved: model display names now config-driven via /admin/model-config API"
gh issue close 1847 -c "Resolved: moved toggle from @click.prevent on label to @change on input"
gh issue close 1825 -c "Resolved: year display above slider, 3 new events (Alice/Kelmscott/WWI), maxYear capped at 1950"
gh issue close 1846 -c "Resolved: Personal (family/friendship/scandal) vs Professional (collaboration/influence) with distinct colors + grouped filter panel"
gh issue close 1848 -c "Resolved: ConnectionDetailSidebar opens on card click, shows strength/narrative/books/story"
```

---

## Mandated Skills

| Skill | When |
|-------|------|
| `superpowers:executing-plans` | Follow this plan task-by-task |
| `superpowers:verification-before-completion` | Before claiming any task is done |
| `superpowers:dispatching-parallel-agents` | Wave 1 (4 independent tracks) |
| `superpowers:using-git-worktrees` | Isolate Wave 1 parallel tracks |
| `/review-changes` | On combined diff before PR |
