# Semantic Versioning with Uplift

**Issue:** #1589
**Date:** 2026-02-02
**Status:** Approved

## Summary

Replace date-based versioning (`YYYY.MM.DD-<short-sha>`) with semantic versioning (`v3.0.1`) using [Uplift](https://upliftci.dev/) and conventional commits. Add PR title validation to enforce commit format. Display version in sidebar for all users.

## Decisions

| Decision | Choice |
|----------|--------|
| Starting version | `v3.0.1` |
| Version source of truth | `backend/pyproject.toml` |
| Version display | Bottom of sidebar (all users) + admin panel (editors) |
| Component versioning | Single version for all components |
| Staging deploy trigger | Push to `staging` (unchanged) |
| Production deploy trigger | Tag push (`v*`) instead of push to `main` |
| Commit enforcement | PR title validation via CI |

## Bump Rules

Handled automatically by Uplift based on conventional commit prefixes (hardcoded per conventional commits spec):

| Prefix | Bump | Changelog | Example |
|--------|------|-----------|---------|
| `feat:` | minor | yes | 3.0.1 -> 3.1.0 |
| `fix:` | patch | yes | 3.0.1 -> 3.0.2 |
| `feat!:` / `BREAKING CHANGE:` | major | yes | 3.0.1 -> 4.0.0 |
| `perf:` / `refactor:` | none (bundled in next release) | yes | no standalone release |
| `docs:` / `chore:` / `ci:` / `test:` | none | no | no release |

**Note:** If a `perf:` change is significant enough to warrant its own release, use `fix:` with a perf-related description instead.

## New Files

### `.uplift.yml`

Uplift configuration:
- Bumps `backend/pyproject.toml` version field via regex
- `perf` and `refactor` included in changelog but do not trigger bumps (conventional commits spec default)
- Changelog includes: `feat`, `fix`, `perf`, `refactor`
- Commit author: `uplift-bot`
- Commit message: `ci(release): v${VERSION}`
- Annotated tags enabled

### `.github/workflows/release.yml`

Triggered on push to `main`:
1. Skip if commit message starts with `ci(release):` (loop prevention)
2. Full git history checkout (`fetch-depth: 0`) with PAT
3. `gembaadvantage/uplift-action@0d28005618a55f97d0bb9253329383720d3e9031` (v2)
4. Runs `uplift release` - analyzes commits, bumps version, creates tag

### `.github/workflows/pr-title.yml`

Triggered on PR open/edit/sync against `staging` and `main`:
- Uses `amannn/action-semantic-pull-request` (pinned to SHA)
- Validates title matches conventional commit format
- Allowed prefixes: `feat`, `fix`, `perf`, `refactor`, `docs`, `chore`, `ci`, `test`, `style`, `build`
- Required status check - blocks merge on failure

### `CHANGELOG.md`

Auto-generated by Uplift after first release.

## Modified Files

### `backend/pyproject.toml`

Update version from `0.1.0` to `3.0.1`.

### `.github/workflows/deploy.yml`

- Production trigger: tag push (`v*`) instead of push to `main`
- Remove `create-release` job (Uplift handles tagging)
- Update `generate-version` job:
  - Production: extract version from git tag
  - Staging: read from `backend/pyproject.toml` + short SHA as build metadata (e.g., `3.0.1+abc1234`)

### Frontend sidebar component

Add `v3.0.1` text at bottom of sidebar, visible to all authenticated users. Uses build-time `APP_VERSION` from Vite config.

### `frontend/vite.config.ts`

Ensure `__APP_VERSION__` reads version from pyproject.toml or VERSION file at build time.

## Unchanged Files

- `backend/app/version.py` - already reads VERSION file, works with any format
- `scraper/Dockerfile` - already accepts VERSION build arg
- Smoke tests - validate version string regardless of format

## Release Flow

```
feature branch -> PR to staging (title validated) -> squash merge
staging -> PR to main -> merge commit
main push -> release.yml -> Uplift bumps pyproject.toml, tags v3.1.0
tag push -> deploy.yml -> production deploy with version v3.1.0
```

Staging deploys happen on push to `staging` with version `3.0.1+abc1234`.

## One-Time Manual Steps

1. Add `PAT` secret to GitHub repo (Uplift needs it to push past branch protection)
2. Tag current main: `git tag v3.0.1 && git push origin v3.0.1`
3. Add `pr-title` job as required status check in branch protection settings

## References

- [Uplift Documentation](https://upliftci.dev/)
- [Conventional Commits](https://www.conventionalcommits.org/)
- [Semantic Versioning](https://semver.org/)
- [pilates-class-scheduler implementation](~/projects/pilates-class-scheduler) (reference implementation)
