# Session: 2026-01-31 08:00

## Issue/Task

Entity Profiles Phase 3 — design/planning session
Parent issue: #1547 (closed as epic tracker)
Scope: Gossip panel (inline expand), mobile optimization, E2E tests

## Current Branch

Planning session only. No branch yet. Implementation deferred to separate session.

## Progress

- [x] Wave 3 deployed to production (PRs #1586, #1587, #1588) — version 2026.01.31-54a767e
- [x] Closed issues #1549, #1550
- [x] Reviewed full SQS/Lambda architecture inventory (5 queues, 3 scheduled jobs, 2 container lambdas)
- [x] Brainstormed Phase 3 — narrowed scope to gossip panel + mobile + E2E
- [x] Design section 1: Gossip panel inline expand (APPROVED)
- [x] Design section 2: Mobile optimization with 3 breakpoints (APPROVED)
- [x] Design section 3: E2E tests for profile + gossip + mobile (APPROVED)
- [x] Explored all entity profile frontend components
- [x] Explored E2E test infrastructure (Playwright, Cognito auth, 4 browser projects)
- [ ] Writing implementation plan (IN PROGRESS — interrupted by compact)
- [ ] Save plan to docs/plans/

## Key Decisions

1. **Gossip panel**: Inline expand (accordion) within KeyConnections card. No drawer, no separate route.
2. **Render style**: Style-adaptive — prose-paragraph, bullet-facts, timeline-events each render differently based on `narrative_style` field.
3. **Tone styling**: Reuse ProfileHero's tone pattern. Extract into shared `useToneStyle()` composable. DRY.
4. **Trigger badge**: Show narrative_trigger as pill badge above expanded content ("Cross-Era Bridge", "Social Circle").
5. **Mobile graph**: Hide EgoNetwork below 768px, replace with inline ConnectionSummary text.
6. **Three breakpoints**: 1024px (existing tablet), 768px (mobile), 480px (small mobile).
7. **E2E scope**: Profile load, gossip panel expand/collapse, mobile layout, navigation between profiles.

## Design Summary (for plan writer)

### New Component: ConnectionGossipPanel.vue
- Receives `RelationshipNarrative` prop
- Three render modes: prose-paragraph, bullet-facts, timeline-events
- BiographicalFact items with tone colors/icons (from shared useToneStyle)
- Year badges on dated facts
- Trigger badge pill at top

### KeyConnections.vue Changes
- Add "View full story" button when `conn.relationship_story` exists
- Toggle accordion expand/collapse with `ref<Set<string>>` tracking open cards
- Render `<ConnectionGossipPanel>` inside expanded card
- Smooth CSS transition on expand

### EntityProfileView.vue Changes
- Swap EgoNetwork for ConnectionSummary below 768px
- Add mobile breakpoint CSS

### Mobile CSS Changes (all profile components)
- ProfileHero: smaller heading/padding at 768px
- KeyConnections: reduced padding at 768px
- CollectionStats: single-column at 480px
- PublicationTimeline: larger touch targets at 768px
- Back nav: larger touch target at 768px

### Shared Composable: useToneStyle()
- Extract from ProfileHero.vue
- Returns CSS class + icon for a given Tone value
- Used by both ProfileHero and ConnectionGossipPanel

### E2E Test: frontend/e2e/entity-profile.spec.ts
- Profile page load (hero, connections, books, stats)
- Gossip panel expand/collapse
- Mobile viewport (EgoNetwork hidden, ConnectionSummary visible)
- Navigation between profiles via connection link
- Uses viewer auth (storageState: .auth/viewer.json)
- Targets staging with real data

## Existing Code Reference

### Components (frontend/src/components/entityprofile/)
| Component | Lines | Key Details |
|-----------|-------|-------------|
| ProfileHero.vue | 114 | Tone styling at line 51 (`:class="--${story.tone}"`) — extract to shared composable |
| KeyConnections.vue | 139 | Cards at line 13-53, narrative at line 30-32 — add gossip expand here |
| EgoNetwork.vue | 160 | Cytoscape graph, 300px fixed height — hide on mobile |
| CollectionStats.vue | 72 | 2x2 grid at line 47 — stack on 480px |
| EntityBooks.vue | ~100 | Pagination, 6 initial |
| PublicationTimeline.vue | ~150 | Horizontal dots |
| ProfileSkeleton.vue | exists | Already has responsive 2→1 col |
| StaleProfileBanner.vue | exists | Regenerate button |
| AllConnections.vue | exists | Simple list |

### Types (frontend/src/types/entityProfile.ts)
- `RelationshipNarrative`: summary, details (BiographicalFact[]), narrative_style
- `BiographicalFact`: text, year?, significance, tone, display_in[]
- `Tone`: dramatic | scandalous | tragic | intellectual | triumphant
- `NarrativeStyle`: prose-paragraph | bullet-facts | timeline-events
- `NarrativeTrigger`: cross_era_bridge | social_circle | hub_figure | influence_chain | null
- `DisplayLocation`: hero-bio | timeline | hover-tooltip | connection-detail

### E2E Infrastructure
- Framework: Playwright 1.57.0
- Location: frontend/e2e/
- Config: frontend/playwright.config.ts
- Auth: Cognito via global-setup.ts → .auth/*.json storage state
- Base URL: https://staging.app.bluemoxon.com
- Browsers: Chromium, WebKit, Mobile Chrome (Pixel 5), Mobile Safari (iPhone 12)
- Run: `npm run --prefix frontend test:e2e`

### Analytics (existing but not wired)
- Composable: frontend/src/composables/socialcircles/useAnalytics.ts
- Pattern: `analytics.trackEvent({ event: "name", properties: {...} })`
- Not integrated into entity profiles yet (deferred to future phase)

## Next Steps (for next compact continuation)

1. **Resume writing implementation plan** — was mid-write when compact requested
2. Save plan to `docs/plans/2026-01-31-phase3-gossip-mobile.md`
3. Plan needs 5 tasks:
   - Task 1: Extract useToneStyle composable from ProfileHero
   - Task 2: Create ConnectionGossipPanel.vue component
   - Task 3: Wire gossip panel into KeyConnections.vue (accordion expand)
   - Task 4: Mobile optimization (CSS breakpoints + EgoNetwork swap)
   - Task 5: E2E tests (entity-profile.spec.ts)
4. Offer execution choice: parallel session or subagent-driven

---

## CRITICAL REMINDERS FOR NEXT SESSION

### Superpowers Skills - MANDATORY

Continue using these skills at ALL stages:

- `superpowers:brainstorming` - before any implementation
- `superpowers:test-driven-development` - when writing code
- `superpowers:systematic-debugging` - when debugging
- `superpowers:writing-plans` - for multi-step tasks
- `superpowers:receiving-code-review` - for review feedback
- Context7 MCP - for library questions
- Sequential-Thinking MCP - for complex reasoning

### Bash Command Rules - NEVER VIOLATE

NEVER use (trigger permission prompts):

- Hash comment lines before commands
- Backslash line continuations
- Dollar-paren command substitution
- Pipe-pipe or ampersand-ampersand chaining
- Exclamation marks in quoted strings

ALWAYS use:

- Simple single-line commands
- Separate sequential Bash tool calls instead of chaining
- bmx-api for all BlueMoxon API calls (no permission prompts)

### BMX API Usage

bmx-api GET /books                    (Staging default)
bmx-api --prod GET /books             (Production)
bmx-api POST /books '{"title":"..."}'

### Implementation Plan Location

Plan will be at: `docs/plans/2026-01-31-phase3-gossip-mobile.md`

### Worktree Setup (for implementation session)

Single worktree needed:
- `.tmp/worktrees/phase3` on `feat/ep-phase3-gossip-mobile` from staging
- All 5 tasks are frontend-only (no backend changes needed)

### Entity Profiles — Complete Status

| Phase | Status | Description |
|-------|--------|-------------|
| Phase 1 | Production | DB + backend + frontend scaffold |
| Phase 2 Wave 1 | Production | Tests + refactors (#1552, #1555, #1557) |
| Phase 2 Wave 2 | Production | narrative_classifier + shared_books (#1553, #1556) |
| Phase 2 Wave 3 | Production | Cache graph + async batch (#1549, #1550) |
| Phase 3 | PLANNING | Gossip panel + mobile + E2E (this session) |
