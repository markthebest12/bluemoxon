name: E2E Tests

on:
  pull_request:
    branches: [staging, main]
    paths:
      - "frontend/src/**"
      - "frontend/e2e/**"
      - "frontend/index.html"
      - "frontend/playwright.config.ts"

concurrency:
  group: e2e-${{ github.ref }}
  cancel-in-progress: true

permissions:
  id-token: write
  contents: read

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      socialcircles: ${{ steps.filter.outputs.socialcircles }}
      entityprofile: ${{ steps.filter.outputs.entityprofile }}
      books: ${{ steps.filter.outputs.books }}
      auth: ${{ steps.filter.outputs.auth }}
      dashboard: ${{ steps.filter.outputs.dashboard }}
      admin: ${{ steps.filter.outputs.admin }}
      profile: ${{ steps.filter.outputs.profile }}
      appshell: ${{ steps.filter.outputs.appshell }}
    steps:
      - uses: actions/checkout@v6
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            socialcircles:
              - 'frontend/src/components/socialcircles/**'
              - 'frontend/src/views/SocialCirclesView.vue'
              - 'frontend/e2e/socialcircles-*.spec.ts'
            entityprofile:
              - 'frontend/src/components/entityprofile/**'
              - 'frontend/src/views/EntityProfileView.vue'
              - 'frontend/src/composables/entityprofile/**'
              - 'frontend/e2e/entity-profile.spec.ts'
            books:
              - 'frontend/src/views/Books*.vue'
              - 'frontend/src/views/BookCreate*.vue'
              - 'frontend/src/views/BookEdit*.vue'
              - 'frontend/src/views/BookDetail*.vue'
              - 'frontend/src/components/book-detail/**'
              - 'frontend/src/components/books/**'
              - 'frontend/e2e/books.spec.ts'
            auth:
              - 'frontend/src/stores/auth.*'
              - 'frontend/src/router/**'
              - 'frontend/src/views/LoginView.vue'
              - 'frontend/e2e/auth.spec.ts'
            dashboard:
              - 'frontend/src/views/HomeView.vue'
              - 'frontend/src/components/dashboard/**'
              - 'frontend/e2e/home.spec.ts'
            admin:
              - 'frontend/src/views/Admin*.vue'
              - 'frontend/src/components/admin/**'
              - 'frontend/e2e/admin.spec.ts'
            profile:
              - 'frontend/src/views/ProfileView.vue'
              - 'frontend/e2e/profile.spec.ts'
            appshell:
              - 'frontend/index.html'
              - 'frontend/src/App.vue'
              - 'frontend/src/components/layout/NavBar.vue'
              - 'frontend/src/assets/main.css'
              - 'frontend/src/composables/useTheme.ts'
              - 'frontend/src/views/HomeView.vue'
              - 'frontend/e2e/app-shell.spec.ts'

  smoke:
    needs: detect-changes
    uses: ./.github/workflows/e2e-suite.yml
    secrets: inherit
    with:
      suite-name: smoke
      test-pattern: "e2e/smoke.spec.ts"

  social-circles:
    needs: detect-changes
    if: needs.detect-changes.outputs.socialcircles == 'true'
    uses: ./.github/workflows/e2e-suite.yml
    secrets: inherit
    with:
      suite-name: social-circles
      test-pattern: "e2e/socialcircles-*.spec.ts"

  entity-profile:
    needs: detect-changes
    if: needs.detect-changes.outputs.entityprofile == 'true'
    uses: ./.github/workflows/e2e-suite.yml
    secrets: inherit
    with:
      suite-name: entity-profile
      test-pattern: "e2e/entity-profile.spec.ts"

  books:
    needs: detect-changes
    if: needs.detect-changes.outputs.books == 'true'
    uses: ./.github/workflows/e2e-suite.yml
    secrets: inherit
    with:
      suite-name: books
      test-pattern: "e2e/books.spec.ts"

  auth:
    needs: detect-changes
    if: needs.detect-changes.outputs.auth == 'true'
    uses: ./.github/workflows/e2e-suite.yml
    secrets: inherit
    with:
      suite-name: auth
      test-pattern: "e2e/auth.spec.ts"

  dashboard:
    needs: detect-changes
    if: needs.detect-changes.outputs.dashboard == 'true'
    uses: ./.github/workflows/e2e-suite.yml
    secrets: inherit
    with:
      suite-name: dashboard
      test-pattern: "e2e/home.spec.ts"

  admin:
    needs: detect-changes
    if: needs.detect-changes.outputs.admin == 'true'
    uses: ./.github/workflows/e2e-suite.yml
    secrets: inherit
    with:
      suite-name: admin
      test-pattern: "e2e/admin.spec.ts"

  profile:
    needs: detect-changes
    if: needs.detect-changes.outputs.profile == 'true'
    uses: ./.github/workflows/e2e-suite.yml
    secrets: inherit
    with:
      suite-name: profile
      test-pattern: "e2e/profile.spec.ts"

  app-shell:
    needs: detect-changes
    if: needs.detect-changes.outputs.appshell == 'true'
    uses: ./.github/workflows/e2e-suite.yml
    secrets: inherit
    with:
      suite-name: app-shell
      test-pattern: "e2e/app-shell.spec.ts"

  performance:
    needs: detect-changes
    uses: ./.github/workflows/e2e-suite.yml
    secrets: inherit
    with:
      suite-name: performance
      test-pattern: "e2e/performance.spec.ts"
      browsers: "chromium"
      playwright-args: "--project=chromium --workers=1"
      relaxed-budgets: true
