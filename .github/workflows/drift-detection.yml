# Drift Detection - Scheduled infrastructure drift checks
# Runs daily and on-demand to detect manual AWS changes
#
# Exit codes from `terraform plan -detailed-exitcode`:
#   0 = No changes (in sync)
#   1 = Error
#   2 = Changes detected (DRIFT!)

name: Drift Detection

on:
  schedule:
    # Run daily at 6 AM UTC (10 PM PST / 11 PM PDT)
    - cron: '0 6 * * *'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to check'
        required: true
        type: choice
        options:
          - both
          - staging
          - production

env:
  AWS_REGION: us-west-2
  TF_VERSION: "1.6.0"

permissions:
  id-token: write
  contents: read
  issues: write  # For creating drift issues

jobs:
  detect-drift:
    name: Check ${{ matrix.environment }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        environment: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.environment != 'both' && fromJSON(format('["{0}"]', github.event.inputs.environment)) || fromJSON('["staging", "production"]') }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ matrix.environment == 'production' && secrets.AWS_DEPLOY_ROLE_ARN || secrets.AWS_STAGING_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Terraform Init
        working-directory: infra/terraform
        run: |
          # Use backend config files as single source of truth (DRY)
          BACKEND_FILE="backends/${{ matrix.environment == 'production' && 'prod' || 'staging' }}.hcl"
          terraform init -backend-config="$BACKEND_FILE"

      - name: Terraform Plan (Drift Check)
        id: plan
        working-directory: infra/terraform
        continue-on-error: true
        run: |
          # Run plan with detailed exit code
          # db_password is a dummy value - drift detection only reads state, doesn't apply changes
          set +e
          terraform plan \
            -detailed-exitcode \
            -var-file=envs/${{ matrix.environment == 'production' && 'prod' || 'staging' }}.tfvars \
            -var="db_password=drift-detection-dummy" \
            -out=drift-plan.tfplan \
            -no-color 2>&1 | tee plan-output.txt

          EXIT_CODE=$?
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT

          # Capture plan summary
          if [ $EXIT_CODE -eq 0 ]; then
            echo "status=in_sync" >> $GITHUB_OUTPUT
            echo "message=No drift detected" >> $GITHUB_OUTPUT
          elif [ $EXIT_CODE -eq 2 ]; then
            echo "status=drift" >> $GITHUB_OUTPUT
            # Extract resource counts from plan
            ADDS=$(grep -c "will be created" plan-output.txt || echo "0")
            CHANGES=$(grep -c "will be updated" plan-output.txt || echo "0")
            DESTROYS=$(grep -c "will be destroyed" plan-output.txt || echo "0")
            echo "message=Drift detected: +$ADDS ~$CHANGES -$DESTROYS" >> $GITHUB_OUTPUT
            echo "adds=$ADDS" >> $GITHUB_OUTPUT
            echo "changes=$CHANGES" >> $GITHUB_OUTPUT
            echo "destroys=$DESTROYS" >> $GITHUB_OUTPUT
          else
            echo "status=error" >> $GITHUB_OUTPUT
            echo "message=Terraform plan failed" >> $GITHUB_OUTPUT
          fi

      - name: Upload plan artifact
        if: steps.plan.outputs.exit_code == '2'
        uses: actions/upload-artifact@v6
        with:
          name: drift-plan-${{ matrix.environment }}
          path: infra/terraform/drift-plan.tfplan
          retention-days: 7

      - name: Create drift issue
        if: steps.plan.outputs.status == 'drift'
        uses: actions/github-script@v8
        with:
          script: |
            const env = '${{ matrix.environment }}';
            const adds = '${{ steps.plan.outputs.adds }}';
            const changes = '${{ steps.plan.outputs.changes }}';
            const destroys = '${{ steps.plan.outputs.destroys }}';
            const runUrl = `${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID}`;

            // Check for existing open drift issue
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'drift,infra',
              per_page: 10
            });

            const existingDriftIssue = existingIssues.data.find(
              issue => issue.title.includes(`[${env}]`) && issue.title.includes('Infrastructure Drift')
            );

            if (existingDriftIssue) {
              // Update existing issue with new detection
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingDriftIssue.number,
                body: `## Drift Still Present - ${new Date().toISOString().split('T')[0]}

            | Metric | Count |
            |--------|-------|
            | Resources to add | ${adds} |
            | Resources to change | ${changes} |
            | Resources to destroy | ${destroys} |

            [View workflow run](${runUrl})`
              });
              console.log(`Updated existing drift issue #${existingDriftIssue.number}`);
            } else {
              // Create new issue
              const issue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `[${env}] Infrastructure Drift Detected`,
                labels: ['drift', 'infra', 'priority:high'],
                body: `## Infrastructure Drift Detected

            **Environment:** ${env}
            **Detected:** ${new Date().toISOString()}

            ### Summary
            | Metric | Count |
            |--------|-------|
            | Resources to add | ${adds} |
            | Resources to change | ${changes} |
            | Resources to destroy | ${destroys} |

            ### Next Steps
            1. Review the [workflow run](${runUrl}) for details
            2. Download the plan artifact to see exact changes
            3. Either:
               - Apply Terraform to fix drift: \`terraform apply\`
               - Import manual resources: \`terraform import\`
               - Document exception in \`docs/MANUAL_CHANGES.md\`

            ### Root Cause Investigation
            - [ ] Was this a manual AWS console change?
            - [ ] Was this a CLI change without Terraform?
            - [ ] Is this expected (pending Terraform PR)?

            ---
            Related: #229 (Infrastructure Parity Epic)`
              });
              console.log(`Created drift issue #${issue.data.number}`);
            }

      - name: Report status
        run: |
          echo "========================================"
          echo "Drift Detection: ${{ matrix.environment }}"
          echo "========================================"
          echo "Status: ${{ steps.plan.outputs.status }}"
          echo "Message: ${{ steps.plan.outputs.message }}"
          echo "========================================"

          if [ "${{ steps.plan.outputs.status }}" == "drift" ]; then
            echo "::warning::Infrastructure drift detected in ${{ matrix.environment }}!"
            exit 0  # Don't fail workflow, just warn
          elif [ "${{ steps.plan.outputs.status }}" == "error" ]; then
            echo "::error::Terraform plan failed for ${{ matrix.environment }}"
            exit 1
          fi

  summary:
    name: Drift Summary
    runs-on: ubuntu-latest
    needs: detect-drift
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "## Drift Detection Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Staging | ${{ needs.detect-drift.result == 'success' && '✅ Checked' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Production | ${{ needs.detect-drift.result == 'success' && '✅ Checked' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
